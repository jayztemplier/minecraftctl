#!/usr/bin/ruby
require 'rubygems'
require 'main'
require 'httpclient'
require 'thread'
Thread.abort_on_exception = true

Main do
	description 'controls minecraft server via minecraftctlserver'

	option 'server', 's' do
		default 'localhost'
		description 'minecraft control server address'
		argument_required
	end

	option 'port', 'p' do
		default 25560
		description 'minecraft control server port'
		argument_required
	end

	argument 'command' do
		description 'command to send to control server: try "/" for available commands'
	end

	argument 'arguments' do
		required false
		arity -1
	end

	run do
		c = HTTPClient.new

		begin
			command = case params['command'].value
				when 'serverhelp'
					'help'
				else
					params['command'].value
			end

			args = params['arguments'].values

			if args.empty?
				c.get_async("http://#{params['server'].value}:#{params['port'].value}#{command}").pop.content.each do |line|
					puts line
				end
			else
				c.post_async("http://#{params['server'].value}:#{params['port'].value}#{command}", args.join("\n")).pop.content.each do |line|
					puts line
				end
			end
		rescue Errno::ECONNREFUSED => e
			puts "Falied to connect to minecraftctlserver; please run minecraftctlserver first: #{e}"
		end
	end
end

